/* esm.sh - esbuild bundle(generic-pool@3.9.0) deno production */
import __events$ from "https://deno.land/std@0.173.0/node/events.ts";var Tt=Object.create;var L=Object.defineProperty;var Et=Object.getOwnPropertyDescriptor;var Ot=Object.getOwnPropertyNames;var bt=Object.getPrototypeOf,yt=Object.prototype.hasOwnProperty;var wt=(i=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(i,{get:(t,e)=>(typeof require<"u"?require:t)[e]}):i)(function(i){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+i+'" is not supported')});var n=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var xt=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Ot(t))!yt.call(i,r)&&r!==e&&L(i,r,{get:()=>t[r],enumerable:!(s=Et(t,r))||s.enumerable});return i};var Pt=(i,t,e)=>(e=i!=null?Tt(bt(i)):{},xt(t||!i||!i.__esModule?L(e,"default",{value:i,enumerable:!0}):e,i));var A=n((Yt,N)=>{N.exports=function(i){if(typeof i.create!="function")throw new TypeError("factory.create must be a function");if(typeof i.destroy!="function")throw new TypeError("factory.destroy must be a function");if(typeof i.validate<"u"&&typeof i.validate!="function")throw new TypeError("factory.validate must be a function")}});var S=n((Kt,B)=>{"use strict";var d=class{constructor(){this.fifo=!0,this.priorityRange=1,this.testOnBorrow=!1,this.testOnReturn=!1,this.autostart=!0,this.evictionRunIntervalMillis=0,this.numTestsPerEvictionRun=3,this.softIdleTimeoutMillis=-1,this.idleTimeoutMillis=3e4,this.acquireTimeoutMillis=null,this.destroyTimeoutMillis=null,this.maxWaitingClients=null,this.min=null,this.max=null,this.Promise=Promise}};B.exports=d});var Q=n((Xt,z)=>{"use strict";var It=S(),m=class{constructor(t){let e=new It;t=t||{},this.fifo=typeof t.fifo=="boolean"?t.fifo:e.fifo,this.priorityRange=t.priorityRange||e.priorityRange,this.testOnBorrow=typeof t.testOnBorrow=="boolean"?t.testOnBorrow:e.testOnBorrow,this.testOnReturn=typeof t.testOnReturn=="boolean"?t.testOnReturn:e.testOnReturn,this.autostart=typeof t.autostart=="boolean"?t.autostart:e.autostart,t.acquireTimeoutMillis&&(this.acquireTimeoutMillis=parseInt(t.acquireTimeoutMillis,10)),t.destroyTimeoutMillis&&(this.destroyTimeoutMillis=parseInt(t.destroyTimeoutMillis,10)),t.maxWaitingClients!==void 0&&(this.maxWaitingClients=parseInt(t.maxWaitingClients,10)),this.max=parseInt(t.max,10),this.min=parseInt(t.min,10),this.max=Math.max(isNaN(this.max)?1:this.max,1),this.min=Math.min(isNaN(this.min)?0:this.min,this.max),this.evictionRunIntervalMillis=t.evictionRunIntervalMillis||e.evictionRunIntervalMillis,this.numTestsPerEvictionRun=t.numTestsPerEvictionRun||e.numTestsPerEvictionRun,this.softIdleTimeoutMillis=t.softIdleTimeoutMillis||e.softIdleTimeoutMillis,this.idleTimeoutMillis=t.idleTimeoutMillis||e.idleTimeoutMillis,this.Promise=t.Promise!=null?t.Promise:e.Promise}};z.exports=m});var _=n((Zt,k)=>{"use strict";var o=class{constructor(t){this._state=o.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=new t((e,s)=>{this._resolve=e,this._reject=s})}get state(){return this._state}get promise(){return this._promise}reject(t){this._state===o.PENDING&&(this._state=o.REJECTED,this._reject(t))}resolve(t){this._state===o.PENDING&&(this._state=o.FULFILLED,this._resolve(t))}};o.PENDING="PENDING";o.FULFILLED="FULFILLED";o.REJECTED="REJECTED";k.exports=o});var W=n(($t,G)=>{"use strict";var v=class extends Error{constructor(t){super(t),this.name=this.constructor.name,this.message=t,typeof Error.captureStackTrace=="function"?Error.captureStackTrace(this,this.constructor):this.stack=new Error(t).stack}},p=class extends v{constructor(t){super(t)}};G.exports={TimeoutError:p}});var V=n((te,F)=>{"use strict";var Dt=_(),Ct=W();function jt(i,t){return function(){return i.apply(t,arguments)}}var u=class extends Dt{constructor(t,e){super(e),this._creationTimestamp=Date.now(),this._timeout=null,t!==void 0&&this.setTimeout(t)}setTimeout(t){if(this._state!==u.PENDING)return;let e=parseInt(t,10);if(isNaN(e)||e<=0)throw new Error("delay must be a positive int");let s=Date.now()-this._creationTimestamp;this._timeout&&this.removeTimeout(),this._timeout=setTimeout(jt(this._fireTimeout,this),Math.max(e-s,0))}removeTimeout(){this._timeout&&clearTimeout(this._timeout),this._timeout=null}_fireTimeout(){this.reject(new Ct.TimeoutError("ResourceRequest timed out"))}reject(t){this.removeTimeout(),super.reject(t)}resolve(t){this.removeTimeout(),super.resolve(t)}};F.exports=u});var H=n((ee,U)=>{"use strict";var qt=_(),g=class extends qt{constructor(t,e){super(e),this._creationTimestamp=Date.now(),this.pooledResource=t}reject(){}};U.exports=g});var Y=n((se,J)=>{"use strict";var Mt={ALLOCATED:"ALLOCATED",IDLE:"IDLE",INVALID:"INVALID",RETURNING:"RETURNING",VALIDATION:"VALIDATION"};J.exports=Mt});var X=n((ie,K)=>{"use strict";var a=Y(),R=class{constructor(t){this.creationTime=Date.now(),this.lastReturnTime=null,this.lastBorrowTime=null,this.lastIdleTime=null,this.obj=t,this.state=a.IDLE}allocate(){this.lastBorrowTime=Date.now(),this.state=a.ALLOCATED}deallocate(){this.lastReturnTime=Date.now(),this.state=a.IDLE}invalidate(){this.state=a.INVALID}test(){this.state=a.VALIDATION}idle(){this.lastIdleTime=Date.now(),this.state=a.IDLE}returning(){this.state=a.RETURNING}};K.exports=R});var E=n((re,Z)=>{"use strict";var T=class{evict(t,e,s){let r=Date.now()-e.lastIdleTime;return t.softIdleTimeoutMillis>0&&t.softIdleTimeoutMillis<r&&t.min<s||t.idleTimeoutMillis<r}};Z.exports=T});var b=n((ne,$)=>{"use strict";var O=class{constructor(){this.head=null,this.tail=null,this.length=0}insertBeginning(t){this.head===null?(this.head=t,this.tail=t,t.prev=null,t.next=null,this.length++):this.insertBefore(this.head,t)}insertEnd(t){this.tail===null?this.insertBeginning(t):this.insertAfter(this.tail,t)}insertAfter(t,e){e.prev=t,e.next=t.next,t.next===null?this.tail=e:t.next.prev=e,t.next=e,this.length++}insertBefore(t,e){e.prev=t.prev,e.next=t,t.prev===null?this.head=e:t.prev.next=e,t.prev=e,this.length++}remove(t){t.prev===null?this.head=t.next:t.prev.next=t.next,t.next===null?this.tail=t.prev:t.next.prev=t.prev,t.prev=null,t.next=null,this.length--}static createNode(t){return{prev:null,next:null,data:t}}};$.exports=O});var et=n((oe,tt)=>{"use strict";var y=class{constructor(t,e){this._list=t,this._direction=e===!0?"prev":"next",this._startPosition=e===!0?"tail":"head",this._started=!1,this._cursor=null,this._done=!1}_start(){this._cursor=this._list[this._startPosition],this._started=!0}_advanceCursor(){if(this._started===!1){this._started=!0,this._cursor=this._list[this._startPosition];return}this._cursor=this._cursor[this._direction]}reset(){this._done=!1,this._started=!1,this._cursor=null}remove(){if(this._started===!1||this._done===!0||this._isCursorDetached())return!1;this._list.remove(this._cursor)}next(){return this._done===!0?{done:!0}:(this._advanceCursor(),this._cursor===null||this._isCursorDetached()?(this._done=!0,{done:!0}):{value:this._cursor,done:!1})}_isCursorDetached(){return this._cursor.prev===null&&this._cursor.next===null&&this._list.tail!==this._cursor&&this._list.head!==this._cursor}};tt.exports=y});var x=n((le,st)=>{"use strict";var Lt=et(),w=class extends Lt{next(){let t=super.next();return t.value&&(t.value=t.value.data),t}};st.exports=w});var f=n((ae,it)=>{"use strict";var P=b(),I=x(),D=class{constructor(){this._list=new P}shift(){if(this.length===0)return;let t=this._list.head;return this._list.remove(t),t.data}unshift(t){let e=P.createNode(t);this._list.insertBeginning(e)}push(t){let e=P.createNode(t);this._list.insertEnd(e)}pop(){if(this.length===0)return;let t=this._list.tail;return this._list.remove(t),t.data}[Symbol.iterator](){return new I(this._list)}iterator(){return new I(this._list)}reverseIterator(){return new I(this._list,!0)}get head(){return this.length===0?void 0:this._list.head.data}get tail(){return this.length===0?void 0:this._list.tail.data}get length(){return this._list.length}};it.exports=D});var nt=n((ue,rt)=>{"use strict";var Nt=b(),At=f(),C=class extends At{push(t){let e=Nt.createNode(t);t.promise.catch(this._createTimeoutRejectionHandler(e)),this._list.insertEnd(e)}_createTimeoutRejectionHandler(t){return e=>{e.name==="TimeoutError"&&this._list.remove(t)}}};rt.exports=C});var q=n((he,ot)=>{"use strict";var Bt=nt(),j=class{constructor(t){this._size=Math.max(+t|0,1),this._slots=[];for(let e=0;e<this._size;e++)this._slots.push(new Bt)}get length(){let t=0;for(let e=0,s=this._slots.length;e<s;e++)t+=this._slots[e].length;return t}enqueue(t,e){e=e&&+e|0||0,e&&(e<0||e>=this._size)&&(e=this._size-1),this._slots[e].push(t)}dequeue(){for(let t=0,e=this._slots.length;t<e;t+=1)if(this._slots[t].length)return this._slots[t].shift()}get head(){for(let t=0,e=this._slots.length;t<e;t+=1)if(this._slots[t].length>0)return this._slots[t].head}get tail(){for(let t=this._slots.length-1;t>=0;t--)if(this._slots[t].length>0)return this._slots[t].tail}};ot.exports=j});var ut=n(at=>{"use strict";function lt(){}at.reflector=function(i){return i.then(lt,lt)}});var ct=n((ve,ht)=>{"use strict";var St=__events$.EventEmitter,zt=A(),Qt=Q(),kt=V(),Gt=H(),Wt=X(),_e=E(),fe=f(),Ft=_(),de=q(),me=x(),h=ut().reflector,Vt="factoryCreateError",Ut="factoryDestroyError",M=class extends St{constructor(t,e,s,r,l){super(),zt(r),this._config=new Qt(l),this._Promise=this._config.Promise,this._factory=r,this._draining=!1,this._started=!1,this._waitingClientsQueue=new s(this._config.priorityRange),this._factoryCreateOperations=new Set,this._factoryDestroyOperations=new Set,this._availableObjects=new e,this._testOnBorrowResources=new Set,this._testOnReturnResources=new Set,this._validationOperations=new Set,this._allObjects=new Set,this._resourceLoans=new Map,this._evictionIterator=this._availableObjects.iterator(),this._evictor=new t,this._scheduledEviction=null,this._config.autostart===!0&&this.start()}_destroy(t){t.invalidate(),this._allObjects.delete(t);let e=this._factory.destroy(t.obj),s=this._config.destroyTimeoutMillis?this._Promise.resolve(this._applyDestroyTimeout(e)):this._Promise.resolve(e);this._trackOperation(s,this._factoryDestroyOperations).catch(r=>{this.emit(Ut,r)}),this._ensureMinimum()}_applyDestroyTimeout(t){let e=new this._Promise((s,r)=>{setTimeout(()=>{r(new Error("destroy timed out"))},this._config.destroyTimeoutMillis).unref()});return this._Promise.race([e,t])}_testOnBorrow(){if(this._availableObjects.length<1)return!1;let t=this._availableObjects.shift();t.test(),this._testOnBorrowResources.add(t);let e=this._factory.validate(t.obj),s=this._Promise.resolve(e);return this._trackOperation(s,this._validationOperations).then(r=>{if(this._testOnBorrowResources.delete(t),r===!1){t.invalidate(),this._destroy(t),this._dispense();return}this._dispatchPooledResourceToNextWaitingClient(t)}),!0}_dispatchResource(){if(this._availableObjects.length<1)return!1;let t=this._availableObjects.shift();return this._dispatchPooledResourceToNextWaitingClient(t),!1}_dispense(){let t=this._waitingClientsQueue.length;if(t<1)return;let e=t-this._potentiallyAllocableResourceCount,s=Math.min(this.spareResourceCapacity,e);for(let r=0;s>r;r++)this._createResource();if(this._config.testOnBorrow===!0){let r=t-this._testOnBorrowResources.size,l=Math.min(this._availableObjects.length,r);for(let c=0;l>c;c++)this._testOnBorrow()}if(this._config.testOnBorrow===!1){let r=Math.min(this._availableObjects.length,t);for(let l=0;r>l;l++)this._dispatchResource()}}_dispatchPooledResourceToNextWaitingClient(t){let e=this._waitingClientsQueue.dequeue();if(e===void 0||e.state!==Ft.PENDING)return this._addPooledResourceToAvailableObjects(t),!1;let s=new Gt(t,this._Promise);return this._resourceLoans.set(t.obj,s),t.allocate(),e.resolve(t.obj),!0}_trackOperation(t,e){return e.add(t),t.then(s=>(e.delete(t),this._Promise.resolve(s)),s=>(e.delete(t),this._Promise.reject(s)))}_createResource(){let t=this._factory.create(),e=this._Promise.resolve(t).then(s=>{let r=new Wt(s);this._allObjects.add(r),this._addPooledResourceToAvailableObjects(r)});this._trackOperation(e,this._factoryCreateOperations).then(()=>(this._dispense(),null)).catch(s=>{this.emit(Vt,s),this._dispense()})}_ensureMinimum(){if(this._draining===!0)return;let t=this._config.min-this._count;for(let e=0;e<t;e++)this._createResource()}_evict(){let t=Math.min(this._config.numTestsPerEvictionRun,this._availableObjects.length),e={softIdleTimeoutMillis:this._config.softIdleTimeoutMillis,idleTimeoutMillis:this._config.idleTimeoutMillis,min:this._config.min};for(let s=0;s<t;){let r=this._evictionIterator.next();if(r.done===!0&&this._availableObjects.length<1){this._evictionIterator.reset();return}if(r.done===!0&&this._availableObjects.length>0){this._evictionIterator.reset();continue}let l=r.value,c=this._evictor.evict(e,l,this._availableObjects.length);s++,c===!0&&(this._evictionIterator.remove(),this._destroy(l))}}_scheduleEvictorRun(){this._config.evictionRunIntervalMillis>0&&(this._scheduledEviction=setTimeout(()=>{this._evict(),this._scheduleEvictorRun()},this._config.evictionRunIntervalMillis).unref())}_descheduleEvictorRun(){this._scheduledEviction&&clearTimeout(this._scheduledEviction),this._scheduledEviction=null}start(){this._draining!==!0&&this._started!==!0&&(this._started=!0,this._scheduleEvictorRun(),this._ensureMinimum())}acquire(t){if(this._started===!1&&this._config.autostart===!1&&this.start(),this._draining)return this._Promise.reject(new Error("pool is draining and cannot accept work"));if(this.spareResourceCapacity<1&&this._availableObjects.length<1&&this._config.maxWaitingClients!==void 0&&this._waitingClientsQueue.length>=this._config.maxWaitingClients)return this._Promise.reject(new Error("max waitingClients count exceeded"));let e=new kt(this._config.acquireTimeoutMillis,this._Promise);return this._waitingClientsQueue.enqueue(e,t),this._dispense(),e.promise}use(t,e){return this.acquire(e).then(s=>t(s).then(r=>(this.release(s),r),r=>{throw this.destroy(s),r}))}isBorrowedResource(t){return this._resourceLoans.has(t)}release(t){let e=this._resourceLoans.get(t);if(e===void 0)return this._Promise.reject(new Error("Resource not currently part of this pool"));this._resourceLoans.delete(t),e.resolve();let s=e.pooledResource;return s.deallocate(),this._addPooledResourceToAvailableObjects(s),this._dispense(),this._Promise.resolve()}destroy(t){let e=this._resourceLoans.get(t);if(e===void 0)return this._Promise.reject(new Error("Resource not currently part of this pool"));this._resourceLoans.delete(t),e.resolve();let s=e.pooledResource;return s.deallocate(),this._destroy(s),this._dispense(),this._Promise.resolve()}_addPooledResourceToAvailableObjects(t){t.idle(),this._config.fifo===!0?this._availableObjects.push(t):this._availableObjects.unshift(t)}drain(){return this._draining=!0,this.__allResourceRequestsSettled().then(()=>this.__allResourcesReturned()).then(()=>{this._descheduleEvictorRun()})}__allResourceRequestsSettled(){return this._waitingClientsQueue.length>0?h(this._waitingClientsQueue.tail.promise):this._Promise.resolve()}__allResourcesReturned(){let t=Array.from(this._resourceLoans.values()).map(e=>e.promise).map(h);return this._Promise.all(t)}clear(){let t=Array.from(this._factoryCreateOperations).map(h);return this._Promise.all(t).then(()=>{for(let s of this._availableObjects)this._destroy(s);let e=Array.from(this._factoryDestroyOperations).map(h);return h(this._Promise.all(e))})}ready(){return new this._Promise(t=>{let e=()=>{this.available>=this.min?t():setTimeout(e,100)};e()})}get _potentiallyAllocableResourceCount(){return this._availableObjects.length+this._testOnBorrowResources.size+this._testOnReturnResources.size+this._factoryCreateOperations.size}get _count(){return this._allObjects.size+this._factoryCreateOperations.size}get spareResourceCapacity(){return this._config.max-(this._allObjects.size+this._factoryCreateOperations.size)}get size(){return this._count}get available(){return this._availableObjects.length}get borrowed(){return this._resourceLoans.size}get pending(){return this._waitingClientsQueue.length}get max(){return this._config.max}get min(){return this._config.min}};ht.exports=M});var pt=n((pe,vt)=>{var _t=ct(),ft=f(),dt=q(),mt=E();vt.exports={Pool:_t,Deque:ft,PriorityQueue:dt,DefaultEvictor:mt,createPool:function(i,t){return new _t(mt,ft,dt,i,t)}}});var Rt=Pt(pt()),{Pool:ge,Deque:Re,PriorityQueue:Te,DefaultEvictor:Ee,createPool:Oe}=Rt,{default:gt,...Ht}=Rt,be=gt!==void 0?gt:Ht;export{Ee as DefaultEvictor,Re as Deque,ge as Pool,Te as PriorityQueue,Oe as createPool,be as default};
